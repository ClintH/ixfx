var R=Object.defineProperty;var O=(i,t,e)=>t in i?R(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var B=(i,t,e)=>(O(i,typeof t!="symbol"?t+"":t,e),e),T=(i,t,e)=>{if(!t.has(i))throw TypeError("Cannot "+e)};var a=(i,t,e)=>(T(i,t,"read from private field"),e?e.call(i):t.get(i)),y=(i,t,e)=>{if(t.has(i))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(i):t.set(i,e)},g=(i,t,e,s)=>(T(i,t,"write to private field"),s?s.call(i,e):t.set(i,e),e),$=(i,t,e,s)=>({set _(r){g(i,t,r,e)},get _(){return a(i,t,s)}});import{d as W,b as P}from"./Envelope.8b6e6092.js";import{b as V,s as X,r as q,c as z}from"./Forms.1d93b762.js";import{t as Y,i as G,g as I}from"./util.7f611b44.js";import{S as J}from"./Events.084fe32f.js";import"./Grid.1cf73ea1.js";import{r as U}from"./ShadowDom.fdb125f9.js";import{r as Q}from"./Util.0a46c3dc.js";import{l as Z}from"./log.b4e81f74.js";import{P as _}from"./Rect.68a6fabc.js";import{f as tt,m as et,d as st}from"./vendor.7c3c5fb6.js";import"./Guards.9dd5c4a2.js";var m,p;const K=class extends Array{constructor(t){super();y(this,m,void 0);y(this,p,void 0);if(Number.isNaN(t))throw Error("capacity is NaN");g(this,m,t),g(this,p,0)}add(t){const e=K.from(this);return e[a(this,p)]=t,g(e,m,a(this,m)),g(e,p,a(this,p)+1===a(this,m)?0:a(this,p)+1),e}get pointer(){return a(this,p)}get isFull(){return a(this,m)===0?!1:this.length===a(this,m)}};let H=K;m=new WeakMap,p=new WeakMap;const it=i=>new H(i);var c;class rt extends J{constructor(t,e={}){super();y(this,c,new Map);B(this,"groupBy");B(this,"type");this.type=t,this.groupBy=e.groupBy??Y}debugString(){const t=Array.from(a(this,c).keys());let e=`Keys: ${t.join(", ")}\r
`;return t.forEach(s=>{const r=a(this,c).get(s);if(r!==void 0){const o=this.type.toArray(r);o!==void 0&&(e+=` - ${s} (${this.type.count(r)}) = ${JSON.stringify(o)}\r
`)}else e+=` - ${s} (undefined)\r
`}),e}get isEmpty(){return a(this,c).size===0}clear(){a(this,c).clear(),super.fireEvent("clear",!0)}addKeyedValues(t,...e){const s=a(this,c).get(t);s===void 0?(a(this,c).set(t,this.type.add(void 0,e)),super.fireEvent("addedKey",{key:t}),super.fireEvent("addedValues",{values:e})):(a(this,c).set(t,this.type.add(s,e)),super.fireEvent("addedValues",{values:e}))}addValue(...t){t.forEach(e=>this.addKeyedValues(this.groupBy(e),e))}hasKeyValue(t,e){const s=a(this,c).get(t);return s===void 0?!1:this.type.has(s,e)}has(t){return a(this,c).has(t)}deleteKeyValue(t,e){const s=a(this,c).get(t);if(s===void 0)return;const r=this.type.without(s,e);a(this,c).set(t,this.type.add(void 0,r))}delete(t){return a(this,c).get(t)===void 0?!1:(a(this,c).delete(t),this.fireEvent("deleteKey",{key:t}),!0)}findKeyForValue(t){return Array.from(a(this,c).keys()).find(r=>{const o=a(this,c).get(r);if(o===void 0)throw Error("Bug: map could not be accessed");return!!this.type.has(o,t)})}count(t){const e=a(this,c).get(t);return e===void 0?0:this.type.count(e)}get(t){const e=a(this,c).get(t);if(e!==void 0)return this.type.toArray(e)}getSource(t){return a(this,c).get(t)}keys(){return Array.from(a(this,c).keys())}keysAndCounts(){return this.keys().map(s=>[s,this.count(s)])}merge(t){t.keys().forEach(s=>{const r=t.get(s);r!==void 0&&this.addKeyedValues(s,...r)})}}c=new WeakMap;const at=i=>{const t=G,e={add:(s,r)=>(s===void 0&&(s=it(i.capacity)),r.forEach(o=>s=s?.add(o)),s),count:s=>s.length,find:(s,r)=>s.find(r),filter:(s,r)=>s.filter(r),toArray:s=>s,has:(s,r)=>s.find(o=>t(o,r))!==void 0,without:(s,r)=>s.filter(o=>!t(o,r))};return new rt(e,i)};var w,S,b,E;class ot{constructor(t){y(this,w,new Map);y(this,S,new Map);B(this,"fallbacks");y(this,b,0);y(this,E,void 0);t!==void 0?this.fallbacks=t:this.fallbacks=["red","blue","green","orange"],g(this,E,document.body)}setElementBase(t){g(this,E,t)}add(t,e){a(this,w).set(t,e)}alias(t,e){a(this,S).set(t,e)}get(t,e){const s=a(this,S).get(t);s!==void 0&&(t=s);const r=a(this,w).get(t);if(r!==void 0)return r;const o="--"+t;let n=getComputedStyle(a(this,E)).getPropertyValue(o).trim();if(n===void 0||n.length===0){if(e!==void 0)return e;n=this.fallbacks[a(this,b)],$(this,b)._++,a(this,b)===this.fallbacks.length&&g(this,b,0)}return n}has(t){return a(this,w).has(t)}}w=new WeakMap,S=new WeakMap,b=new WeakMap,E=new WeakMap;const nt=(i,t,e=1e3)=>Q(i,e).subscribe(r=>{const o=r.find(n=>n.target===i);o!==void 0&&(i.width=o.contentRect.width,i.height=o.contentRect.height,t())}),ct=i=>{const t=i.keys(),e=[];return t.forEach(s=>{const r=i.get(s);if(r===void 0)return;let{min:o,max:n}=I(r),l=n-o;l===0&&(l=o,o=o-l/2,n=n+l/2),e.push({min:o,max:n,range:l,name:s})}),e},lt=(i,t,e="")=>{i.addKeyedValues(e,t)},L=(i,t)=>{const{ctx:e,yLabelWidth:s,width:r,height:o}=t,n=t.showYAxis??!0,l=ct(i),d=10;e.clearRect(0,0,r,o),e.translate(d,0),n&&l.forEach(u=>{t.yAxes!==void 0&&(typeof t.yAxes=="string"&&u.name!==t.yAxes||!t.yAxes.includes(u.name))||(dt(u,t),e.translate(s+3,0))});const h={...t,width:r-d-d-(n?s:0),height:o-d-d};h.dataXScale=h.width/t.capacity,e.translate(0,d),l.forEach(u=>{const f=i.getSource(u.name);f!==void 0&&ht(u,f,h)}),e.resetTransform()},dt=(i,t)=>{const{ctx:e,height:s,palette:r,width:o}=t;r.has(i.name+"-axis")?e.fillStyle=r.get(i.name+"-axis"):e.fillStyle=r.get(i.name);const n=i.min+i.range/2,l=t.textHeight/2,d=6;e.textBaseline="top",e.fillText(i.min.toFixed(2),0,s-t.textHeight-d),e.fillText(i.max.toFixed(2),0,l),e.fillText(n.toFixed(2),0,s/2-l)},ht=(i,t,e)=>{const{ctx:s,height:r,width:o,dataXScale:n=1,lineWidth:l=2}=e;let d=0,h;s.beginPath(),s.lineWidth=l,s.strokeStyle=e.palette.get(i.name);const u=e.coalesce&&e.dataXScale<0?Math.floor(1/e.dataXScale):1;for(let f=0;f<t.length;f+=u){let A=(1-(t[f]-i.min)/i.range)*r;f==0&&s.moveTo(d,A),s.lineTo(d,A),d+=n,f+1==t.pointer&&(h={x:d,y:A})}s.stroke(),h!==void 0&&(s.beginPath(),s.arc(h.x,h.y,3,0,2*Math.PI),s.fill())},ut=(i,t)=>{const e=U(i);if(e.nodeName==="CANVAS")throw new Error("Parent element should be a container, not a CANVAS");const s=document.createElement("CANVAS");s.style.width="100%",s.style.height="100%",e.append(s);const r=s.getContext("2d"),o=t.capacity??10,n=at({capacity:o}),l=r.measureText("Xy"),d=t.coalesce??!0;let h={...t,capacity:o,coalesce:d,textHeight:t.textHeight??l.actualBoundingBoxAscent+l.actualBoundingBoxDescent,palette:t.palette??new ot,width:s.width,height:s.height,ctx:r,yLabelWidth:25};return nt(s,()=>{h={...h,width:s.width,height:s.height},L(n,h)}),{add:(u,f="",A=!1)=>{lt(n,u,f),!A&&L(n,h)},clear:()=>{n.clear()}}},x=Z("#envDataStream",{minIntervalMs:20,capacity:150}),D=new _;D.add("scaled","yellow");D.add("scaled-axis","whitesmoke");const N=ut("#envData",{capacity:300,showYAxis:!0,palette:D,lineWidth:3});let M={...W(),attackBend:1,decayBend:-1,releaseBend:1},C=!1,v=P({...M,shouldLoop:C});v.addEventListener("change",i=>{V("#btnRelease").disabled=i.newState!=="sustain"});V("#btnTriggerHold",()=>{x.clear(),v.trigger(!0),k()});V("#btnRelease",()=>{v.release()});V("#btnTrigger",()=>{x.clear(),v.trigger(),k()});const ft=X("#selectShow",i=>{N.clear(),x.log(),k()});tt(q("#envEditor"),"change").pipe(et(i=>i.detail),st(1e3)).subscribe(i=>{M=i,console.log("hello"),F()});const F=()=>{try{v=P({...M,shouldLoop:C}),v.trigger(),x.clear(),N.clear(),k()}catch(i){x.error(i)}};z("#chkLooping",i=>{C=i,F()});let j=!1;const k=()=>{if(j)return;const i=function(){let[t,e,s]=v.compute();if(t===void 0){j=!1;return}const r=ft.value==="raw"?s:e;N.add(r),x.log(`${t} ${r.toFixed(3)}`),v.isDone?(console.log("Envelope done"),j=!1):(j=!0,window.requestAnimationFrame(i))};window.requestAnimationFrame(i)};F();
