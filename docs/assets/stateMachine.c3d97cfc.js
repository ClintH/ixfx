var H=(s,e,t)=>{if(!e.has(s))throw TypeError("Cannot "+t)};var d=(s,e,t)=>(H(s,e,"read from private field"),t?t.call(s):e.get(s)),S=(s,e,t)=>{if(e.has(s))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(s):e.set(s,t)},f=(s,e,t,n)=>(H(s,e,"write to private field"),n?n.call(s,t):e.set(s,t),t);import{r as z,a as q}from"./ShadowDom.fdb125f9.js";import{s as j,b as W}from"./Forms.1d93b762.js";import{S as Q}from"./Events.084fe32f.js";import{a as U}from"./Guards.9dd5c4a2.js";const X=(s,e={})=>{const{capacity:t=0,monospaced:n=!0,timestamp:r=!1,collapseDuplicates:p=!0}=e;let N=0,h,l=0;const o=z(s),k=q(o,`
  .log {
    font-family: ${n?'Consolas, "Andale Mono WT", "Andale Mono", "Lucida Console", "Lucida Sans Typewriter", "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Liberation Mono", Monaco, "Courier New", Courier, monospace':"normal"};
    background-color: var(--code-background-color);
    padding: var(--padding1, 0.2em);
  }
  .timestamp {
    margin-right: 0.5em;
    opacity: 0.5;
    font-size: 70%;
    align-self: center;
  }
  .line {
    display: flex;
  }
  .line:hover {
    background-color: var(--theme-bg-hover, whitesmoke);
  }
  .error {
    color: red;
  }
  .badge {
    border: 1px solid currentColor;
    align-self: center;
    font-size: 70%;
    padding-left: 0.2em;
    padding-right: 0.2em;
    border-radius: 1em;
    margin-left: 0.5em;
    margin-right: 0.5em;
  }
  .msg {
    flex: 1;
  }
  `),g=document.createElement("div");g.className="log",k.append(g);const F=a=>{const i=document.createElement("div");if(typeof a=="string")i.innerHTML=a;else if(a instanceof Error){const y=a.stack;y===void 0?i.innerHTML=a.toString():i.innerHTML=y.toString()}else i.innerHTML=a;i.classList.add("error"),w(i),h=void 0,l=0};let B=0;const R=(a="")=>{let i;const y=window.performance.now()-B;if(!(e.minIntervalMs&&y<e.minIntervalMs))if(B=window.performance.now(),typeof a=="object"?i=JSON.stringify(a):a===void 0?i="(undefined)":a===null?i="(null)":typeof a=="number"?(Number.isNaN(i)&&(i="(NaN)"),i=a.toString()):i=a,i.length===0){const v=document.createElement("hr");h=void 0,w(v)}else if(i===h&&p){const v=g.firstElementChild;let M=v.querySelector(".badge");M===null&&(M=document.createElement("div"),M.className="badge",v.insertAdjacentElement("beforeend",M)),v!==null&&(M.textContent=(++l).toString())}else{const v=document.createElement("div");v.innerHTML=i,w(v),h=i}},w=a=>{if(r){const i=document.createElement("div"),y=document.createElement("div");y.className="timestamp",y.innerText=new Date().toLocaleTimeString(),i.append(y,a),a.classList.add("msg"),i.classList.add("line"),a=i}else a.classList.add("line","msg");if(g.insertBefore(a,g.firstChild),t>0&&++N>t*2)for(;N>t;)g.lastChild?.remove(),N--;l=0};return{error:F,log:R,append:w,clear:()=>{g.innerHTML="",h=void 0,l=0},dispose:()=>{g.remove()}}};var u,A,m,b,C;const D=class extends Q{constructor(e,t,n={debug:!1}){super();S(this,u,void 0);S(this,A,void 0);S(this,m,void 0);S(this,b,void 0);S(this,C,void 0);const[r,p]=D.validate(e,t);if(!r)throw new Error(p);f(this,C,e),f(this,m,t),f(this,A,n.debug??!1),f(this,u,e),f(this,b,!1)}get states(){return Object.keys(d(this,m))}static validate(e,t){const n=Object.keys(t),r=new Set,p=new Set;for(let l=0;l<n.length;l++){const o=n[l];if(r.has(o))return[!1,`Key ${o} is already used`];if(r.add(o),typeof n[l]!="string")return[!1,`Key[${l}] is not a string`];const c=t[o];if(c===void 0)return[!1,`Key ${o} value is undefined`];if(typeof c=="string"){if(p.add(c),c===o)return[!1,`Loop present for ${o}`]}else if(Array.isArray(c)){if(!U(c))return[!1,`Key ${o} value is not an array of strings`];if(c.forEach(k=>p.add(k)),c.find(k=>k===o))return[!1,`Loop present for ${o}`]}else if(c!==null)return[!1,`Key ${o} has a value that is neither null, string or array`]}const h=Array.from(p).find(l=>!r.has(l));return h?[!1,`Potential state '${h}' does not exist as a top-level state`]:t[e]===void 0?[!1,`Initial state ${e} not present`]:[!0,""]}next(){const e=d(this,m)[d(this,u)];if(e===null)return null;if(Array.isArray(e))if(typeof e[0]=="string")this.state=e[0];else throw new Error("Error in machine description. Potential state array does not contain strings");else if(typeof e=="string")this.state=e;else throw new Error("Error in machine description. Potential state is neither array nor string");return this.state}get isDone(){return d(this,b)}reset(){f(this,b,!1),f(this,u,d(this,C))}static isValid(e,t,n){if(n[t]===void 0)return[!1,`Machine cannot change to non-existent state ${t}`];const r=n[e];if(Array.isArray(r)){if(!r.includes(t))return[!1,`Machine cannot ${e} -> ${t}. Allowed transitions: ${r.join(", ")}`]}else if(t!==r&&r!=="*")return[!1,`Machine cannot ${e} -> ${t}. Allowed transition: ${r}`];return[!0,"ok"]}isValid(e){return D.isValid(this.state,e,d(this,m))}set state(e){const t=d(this,u),[n,r]=D.isValid(t,e,d(this,m));if(!n)throw new Error(r);d(this,A)&&console.log(`StateMachine: ${t} -> ${e}`),f(this,u,e),d(this,m)[e]===null&&f(this,b,!0),setTimeout(()=>{this.fireEvent("change",{newState:e,priorState:t}),this.isDone&&this.fireEvent("stop",{state:e})},1)}get state(){return d(this,u)}};let K=D;u=new WeakMap,A=new WeakMap,m=new WeakMap,b=new WeakMap,C=new WeakMap;const $=X("#dataStream",{capacity:8,timestamp:!1});let x;const P={morningRoutine:{description:{sleep:"wakeup",wakeup:["coffee","breakfast"],coffee:"bike",breakfast:"bike",bike:null},initialState:"sleep"},loop:{description:{tideGoesIn:"tideGoesOut",tideGoesOut:"tideGoesIn"},initialState:"tideIn"},bread:{description:{plain:["toasted","buttered","eaten"],toasted:["buttered","eaten","diced"],buttered:["eaten","marmaladed"],marmaladed:"eaten",diced:"sprinkled-on-soup","sprinkled-on-soup":null,eaten:null},initialState:"plain"}},O=document.getElementById("btnChangeState"),V=document.getElementById("descrValidate"),L=document.getElementById("jsonDescr");L.addEventListener("input",()=>{console.log(L.innerText);let[s,e]=Y(L.innerText);s?(e="\u2714 OK",V.classList.remove("error")):(e=e,V.classList.add("error")),V.innerHTML=e});const G=document.getElementById("currentState"),T=j("#selDescrInitial"),E=j("#selPossibleNext",void 0,{placeholderOpt:"-- Auto --",autoSelectAfterChoice:0}),J=j("#selDemoMachines",s=>{let e=P[s];L.innerText=JSON.stringify(e.description,void 0,2),T.setOpts(Object.keys(e.description),e.initialState)},{shouldAddChoosePlaceholder:!0,autoSelectAfterChoice:0});J.setOpts(Object.keys(P));const Y=s=>{try{const e=JSON.parse(s);return T.setOpts(Object.keys(e)),[!0,""]}catch(e){return[!1,e.message]}},Z=W("#btnSetDescr",()=>{try{let s=L.innerText;const e=JSON.parse(s),t=T.value,n=_(t,e);x=n,I(n),$.clear()}catch(s){console.error(s),$.error(s.message),I(void 0)}}),I=s=>{if(s===void 0){O.disabled=!0,E.disabled=!0,G.innerText="(invalid JSON)",E.setOpts([]);return}G.innerText=`Current state: ${s.state}`,E.setOpts(s.states.filter(e=>s.isValid(e)[0])),O.disabled=s.isDone,E.disabled=s.isDone},_=(s,e)=>{let t={debug:!1},n=new K(s,e,t);return n.addEventListener("change",r=>{$.log(`'${r.priorState}' -> '${r.newState}'`),I(n)}),n.addEventListener("stop",r=>{$.log(`Completed. Final state: '${r.state}'`)}),n};O.addEventListener("click",()=>{if(x===void 0){$.log("No machine set");return}E.isSelectedPlaceholder?x.next():x.state=E.value});J.select(1,!0);Z.click();
